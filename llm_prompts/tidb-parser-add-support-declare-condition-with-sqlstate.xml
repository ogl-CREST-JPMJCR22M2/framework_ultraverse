<agent-task mode="planning">
    <objective>
        # Support DECLARE CONDITION with SQLSTATE syntax

        - 현재 tidb/parser는 DECLARE CONDITION with SQLSTATE 신택스를 지원하지 않습니다. (see below)
        - 위 신택스를 지원하기 위한 계획을 세워 주십시오.
    </objective>
    <stderr>
        Error: line 3 column 41 near "CONDITION FOR SQLSTATE '45002';
    </stderr>
    <code lang="sql; variant=mysql">
        CREATE PROCEDURE test_proc()
        BEGIN
            DECLARE insufficient_funds CONDITION FOR SQLSTATE '45002';
            SELECT 1;
        END;
    </code>
    <hint source="claude-code (claude-opus-4-5-20251101)">
        (아래는 SELECT INTO 지원 시의 대화 내역입니다. 참고용으로만 사용하십시오)
        ⏺ 형아, SELECT INTO 구문이 실패하고 있어:

        testing SELECT score INTO game_score FROM game_records WHERE user_id = 1; ... FAIL
        parser error: line 1 column 28 near "game_score FROM game_records WHERE user_id = 1;"

        TiDB 파서가 MySQL 프로시저 스타일의 SELECT ... INTO variable 구문을 지원하지 않는 것 같아. TiDB는 SELECT ... INTO OUTFILE/DUMPFILE은 지원하지만, 변수 할당 구문은 지원하지 않는 것 같아.

        계획서에서 "TiDB 파서가 SELECT INTO 지원"이라고 했는데, 어떻게 진행할까?

        1. TiDB 파서 포크에 SELECT INTO 지원 추가 - 파서 문법 수정 필요
        2. 기존 방식 유지 - ult_sanitize_select_into로 INTO 부분을 제거하고, extract_select_into로 변수 정보 추출해서 into_variables 필드에 채우기
        3. 다른 방안이 있으면 알려줘

        ❯ 1. 일단 포크해서 INTO를 지원할 수 있도록 하는 버전을 만들어올게. 그런데, 포크한 버전은 go에서 어떻게 설치하지? 그냥 github username/repo 형식이면 그것만 바꾸면 되는건가?
        ❯ 혹시 tidb/parser에서 어느 파일 만져야 하는지만 알려줄 수 있어?

        ⏺ 응! TiDB 파서에서 SELECT INTO 변수 할당을 추가하려면 이 파일들을 봐야 해:

        ⏺ Bash(ls -la /Users/cheesekun/go/pkg/mod/github.com/pingcap/tidb/pkg/parser@v0.0.0-20260121072752-93c65e2234ad/)
        ⎿  total 17936
        dr-xr-xr-x@ 48 cheesekun  staff     1536  1월 21 17:00 .
        drwxr-xr-x@  3 cheesekun  staff       96  1월 21 17:00 ..
        … +46 lines (ctrl+o to expand)

        ⏺ 주요 파일들:

        1. parser.y - yacc 문법 파일 (가장 중요!)
        2. ast/dml.go - SelectStmt 구조체 정의
        3. parser.go - parser.y에서 자동 생성됨 (직접 수정 X)

        parser.y에서 SELECT 문법 부분을 찾아볼게:

        ⏺ Bash(grep -n "SelectStmt\|SelectInto\|INTO" /Users/cheesekun/go/pkg/mod/github.com/pingcap/tidb/pkg/parser@v0.0.0-20260121072752-93c65e2234ad/parser.y | head -50)
        ⎿  178:       into              "INTO"
        1043:      InsertIntoStmt             "INSERT INTO statement"
        1045:      ImportIntoStmt             "IMPORT INTO statement"
        … +47 lines (ctrl+o to expand)

        ⏺ Bash(grep -n -A 20 "SelectStmtIntoOption:" /Users/cheesekun/go/pkg/mod/github.com/pingcap/tidb/pkg/parser@v0.0.0-20260121072752-93c65e2234ad/parser.y)
        ⎿  10567:SelectStmtIntoOption:
        10568-     {
        10569-             $$ = nil
        … +18 lines (ctrl+o to expand)

        ⏺ 찾았어! 수정해야 할 파일들:

        1. parser.y (문법 파일)

        10567번 줄 근처의 SelectStmtIntoOption: 규칙에 변수 할당 케이스 추가:

        SelectStmtIntoOption:
        {
        $$ = nil
        }
        |     "INTO" "OUTFILE" stringLit Fields Lines
        {
        // ... 기존 OUTFILE 코드 ...
        }
        |     "INTO" VariableList      // <-- 이거 추가!
        {
        // 변수 목록을 저장하는 로직
        }

        2. ast/dml.go (AST 정의)

        SelectStmt 구조체에 변수 목록 필드 추가하거나, SelectIntoOption 확장:

        // SelectStmt에 추가
        type SelectStmt struct {
        // ... 기존 필드들 ...
        IntoVariables []*VariableExpr  // <-- 추가
        }

        또는 SelectIntoOption에:
        type SelectIntoOption struct {
        Tp         SelectIntoType
        FileName   string
        FieldsInfo *FieldsClause
        LinesInfo  *LinesClause
        Variables  []*VariableExpr  // <-- 추가
        }

        3. 빌드

        수정 후 make 하면 parser.y → parser.go 자동 생성돼.

        ---
        참고로 MySQL의 SELECT INTO 변수 문법은:
        SELECT col1, col2 INTO @var1, @var2 FROM table;
        SELECT col1, col2 INTO var1, var2 FROM table;  -- 프로시저 내부

        포크 작업 시 VariableList 문법 규칙도 확인해봐! (parser.y에서 Variable: 검색)
    </hint>
    <agent-rule>
        - **Harmony (和) is important; be harmonious**: AI-generated code is generally not welcomed. Please respect the existing code conventions as much as possible to ensure your code harmonizes with the work of other TiDB contributors.
    </agent-rule>
</agent-task>